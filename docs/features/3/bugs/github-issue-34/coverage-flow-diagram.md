# Coverage Data Flow Diagram

## Current Workflow (BROKEN)

```
┌─────────────────────────────────────────────────────────────────────┐
│ Step 1: Run tests with coverage (make test)                        │
│ Command: PYTHONPATH=src poetry run pytest                          │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│ Coverage Collection (parallel mode enabled)                        │
│                                                                     │
│  Test Process 1  →  .coverage.proc1  ┐                             │
│  Test Process 2  →  .coverage.proc2  ├──→ Multiple .coverage.*     │
│  Test Process N  →  .coverage.procN  ┘    files created            │
│                                                                     │
│  pytest-cov INTERNALLY combines these for its reports               │
│  Output: "TOTAL: 92.67%" ✅                                         │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│ Step 2: Upload coverage reports                                    │
│ Uploads: htmlcov/, coverage.xml, coverage.json                     │
│ (Generated by pytest-cov with combined data)                       │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│ Step 3: Coverage summary (informational)                           │
│ Command: poetry run coverage report                                │
│                                                                     │
│ ⚠️  Reads .coverage file (only partial data!)                       │
│ ⚠️  Shows incorrect coverage percentage                             │
│ ⚠️  Uses || true (errors ignored)                                   │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│ Step 4: Check coverage threshold ❌ FAILS HERE                      │
│ Command: poetry run coverage report | grep TOTAL                   │
│                                                                     │
│ ⚠️  Reads .coverage file (only partial data!)                       │
│ ⚠️  Result: "Total coverage: 8%" (WRONG!)                           │
│ ⚠️  8% < 80% threshold → BUILD FAILS                                │
└─────────────────────────────────────────────────────────────────────┘
```

## Fixed Workflow (RECOMMENDED)

```
┌─────────────────────────────────────────────────────────────────────┐
│ Step 1: Run tests with coverage (make test)                        │
│ Command: PYTHONPATH=src poetry run pytest                          │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│ Coverage Collection (parallel mode enabled)                        │
│                                                                     │
│  Test Process 1  →  .coverage.proc1  ┐                             │
│  Test Process 2  →  .coverage.proc2  ├──→ Multiple .coverage.*     │
│  Test Process N  →  .coverage.procN  ┘    files created            │
│                                                                     │
│  pytest-cov INTERNALLY combines these for its reports               │
│  Output: "TOTAL: 92.67%" ✅                                         │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│ Step 2: Upload coverage reports                                    │
│ Uploads: htmlcov/, coverage.xml, coverage.json                     │
│ (Generated by pytest-cov with combined data)                       │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│ Step 3: Combine coverage data files ✨ NEW STEP                     │
│ Command: poetry run coverage combine                               │
│                                                                     │
│ ✅ Combines all .coverage.* files into single .coverage file         │
│ ✅ Creates complete coverage database                                │
└────────────────────────────────┬────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│ Step 4: Check coverage threshold ✅ NOW WORKS                       │
│ Command: poetry run coverage report --fail-under=80                │
│                                                                     │
│ ✅ Reads complete .coverage file (all data combined)                 │
│ ✅ Result: "Total coverage: 92.67%" (CORRECT!)                       │
│ ✅ 92.67% > 80% threshold → BUILD PASSES                             │
└─────────────────────────────────────────────────────────────────────┘
```

## Why the Discrepancy Occurs

### Parallel Coverage Mode

```
pyproject.toml Configuration:
┌────────────────────────────────────────────┐
│ [tool.coverage.run]                        │
│ parallel = true          ← ENABLES THIS    │
│ concurrency = [                            │
│   "thread",                                │
│   "multiprocessing"                        │
│ ]                                          │
└────────────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────┐
│ Coverage creates MULTIPLE files:           │
│                                            │
│  .coverage.proc1.12345                     │
│  .coverage.proc2.12346                     │
│  .coverage.proc3.12347                     │
│  ...                                       │
│                                            │
│ Each file = coverage from ONE process      │
└────────────────────────────────────────────┘
```

### Pytest-cov vs Standalone Coverage Commands

```
┌─────────────────────────────────────────────────────────────────────┐
│ Pytest-cov (during test execution)                                 │
│                                                                     │
│  1. Collects coverage across all processes                         │
│  2. AUTOMATICALLY combines .coverage.* files internally            │
│  3. Generates reports with COMPLETE data                           │
│  4. Shows: 92.67% coverage ✅                                       │
│                                                                     │
│  This is why "make test" shows correct coverage!                   │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ Standalone "coverage report" command                                │
│                                                                     │
│  1. Looks for .coverage file                                       │
│  2. Does NOT automatically combine .coverage.* files               │
│  3. Reads PARTIAL data (only one file)                             │
│  4. Shows: 8% coverage ❌                                           │
│                                                                     │
│  This is why threshold check fails!                                │
│                                                                     │
│  FIX: Run "coverage combine" first to merge all files              │
└─────────────────────────────────────────────────────────────────────┘
```

## Coverage Combine Process

```
BEFORE coverage combine:
├── .coverage.proc1.12345    (Process 1 data - 8% of code)
├── .coverage.proc2.12346    (Process 2 data - 20% of code)
├── .coverage.proc3.12347    (Process 3 data - 15% of code)
├── .coverage.proc4.12348    (Process 4 data - 25% of code)
└── .coverage.proc5.12349    (Process 5 data - 24.67% of code)
                                              ─────────────
                                              Total: 92.67%

AFTER coverage combine:
└── .coverage                (Combined data - 92.67% of code) ✅
```

## File Size Evidence

```bash
# Typical .coverage.* file (partial data)
-rw-r--r-- 1 runner runner   8192 Oct 19 14:23 .coverage.proc1.12345

# Combined .coverage file (complete data)
-rw-r--r-- 1 runner runner  69632 Oct 19 14:24 .coverage
```

The combined file is MUCH larger because it contains ALL coverage data from all processes.

## Solution Implementation

### Minimal Change Required

```yaml
# .github/workflows/backend-ci.yml

# BEFORE (current - broken):
- name: Check coverage threshold
  run: |
    COVERAGE=$(poetry run coverage report | grep TOTAL | awk '{print $4}' | sed 's/%//')
    echo "Total coverage: ${COVERAGE}%"
    if (( $(echo "$COVERAGE < 80" | bc -l) )); then
      echo "❌ Coverage ${COVERAGE}% is below the required 80% threshold"
      exit 1
    fi

# AFTER (fixed):
- name: Combine coverage data files
  run: poetry run coverage combine

- name: Check coverage threshold
  run: |
    echo "Checking coverage meets 80% threshold..."
    poetry run coverage report --fail-under=80
    echo "✅ Coverage meets the 80% threshold"
```

### What Changed?

1. **Added:** `coverage combine` step (1 line)
2. **Simplified:** Threshold check using native `--fail-under=80` flag
3. **Result:** Workflow now reads COMPLETE coverage data

## Key Takeaways

1. **Parallel coverage mode creates multiple data files** - This is normal and expected
2. **Pytest-cov handles combining automatically** - For its own reports
3. **Standalone coverage commands do NOT auto-combine** - Must run `coverage combine` first
4. **Always combine before reporting** - Best practice for parallel mode
5. **The fix is simple** - Just one new workflow step

---

**Diagram Version:** 1.0
**Last Updated:** 2025-10-19
**Author:** DevOps Engineer Agent
